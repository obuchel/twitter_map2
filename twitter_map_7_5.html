

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Draw GeoJSON points</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js" integrity="sha512-JcFoojcQ0rbfND1k7MUi73RwOdhE79qQiFiflXpMr++I9r30gJB+sZkhKZCW1Pee6poQrTgiQPfzhgiBwGhHEA==" crossorigin="anonymous"></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
  var popup;
  
mapboxgl.accessToken = 'pk.eyJ1Ijoib2J1Y2hlbCIsImEiOiJmOWQ2MzQxNmE0M2Y3YmVjNzA2NmM2MGQzYTIwYmQ3OCJ9.psxJSN8q9n2-HfFGoIUNJA';
var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/light-v10',
center: [-96, 37.8],
zoom: 3
});
 
map.on('load', function () {
    // Add an image to use as a custom marker


var dd=map.addSource('points1', {
'type': 'geojson',
'data': 'supercommunities_twitter_improved_all2_short_last2_7_1_updated2_filtered_5.json'
});
// Add a symbol layer                                                                                                                                                                
map.addLayer({
'id': 'points1',
'type': 'circle',
'source': 'points1',
    'paint':{
// make circles larger as the user zooms from z12 to z22                                                                                                                            
 //   'circle-radius': 3,                                                                                                                                                           
    'circle-radius': ['get', 's'],
// color circles by ethnicity, using a match expression                                                                                                                             
// https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match                                                                                                               
    'circle-color': ['get', 'color'],
    'circle-stroke-color':'#000000',
    'circle-stroke-width':0.2

}
});    
    

    map.on('click', 'points1', function(e) {
	
	if (typeof popup=="object") popup.remove();
	//var features = map.querySourceFeatures('points1');
     //console.log(features);

    var lats=e.lngLat;
    var htm=e.features[0]["properties"]["title"]+" "+e.features[0]["properties"]["color"];
popup=new mapboxgl.Popup()
.setLngLat(lats)
.setHTML(htm)
	    .addTo(map);
	var l=e.features[0]['properties']['title'].split(' ')[2];
	//console.log(l);

	fetch(l.substr(0,2)+'.json')
  .then(response => response.json())
	    .then(data => {
		var dd=data[l];
		var kkeys=d3.keys(dd);
		//console.log(d3.values(dd));
		//console.log(dd);

		var kks=[];
		var vals=[];
		var kks0=[];
                var vals0=[];
for (var i=0; i<kkeys.length; i++) {
    kks.push(kkeys[i]);
     kks0.push(2);
    vals.push(2+d3.values(dd)[i]/d3.sum(d3.values(dd))*10);
     vals0.push(0.5);
/*		    
map.setPaintProperty(
  'points1', 
  'circle-radius', 
    ['match', ['get', 'id'], kkeys[i], 2+d3.values(dd)[i]/d3.sum(d3.values(dd))*10 ]
);

    map.setPaintProperty(
  'points1',
  'circle-opacity',
    ['match', ['get', 'id'], kkeys[i], 1 ]
);
*/
		}		    



/*

		map.setPaintProperty(
  'points1',
    'circle-radius', ['match', ['get', 'id'], kks,kks0 ]  
                );

                 map.setPaintProperty(
  'points1',
		     'circle-opacity',['match', ['get', 'id'],vals,vals0]
                );
*/

		map.setFilter(layer, '==', ['get', 'id'], kks);
	    });	
/*      
map.setPaintProperty(
  ['match', ['get', 'title'], 'example-id', 0.5 , 1], 'circle-radius',0 
//  ['match', ['get', 'id'], 'example-id', 0.5 , 1]
);
*/

});


    

});
</script>
 
</body>
</html>
