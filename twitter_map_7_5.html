

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Draw GeoJSON points</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js" integrity="sha512-JcFoojcQ0rbfND1k7MUi73RwOdhE79qQiFiflXpMr++I9r30gJB+sZkhKZCW1Pee6poQrTgiQPfzhgiBwGhHEA==" crossorigin="anonymous"></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }

	/**
* Set rules for how the map overlays
* (information box and legend) will be displayed
* on the page. */
.map-overlay {
  position: absolute;
  bottom: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.8);
  margin-right: 20px;
  font-family: Arial, sans-serif;
  overflow: auto;
  border-radius: 3px;
}


#legend {
  padding: 10px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  line-height: 18px;
  height: 150px;
  margin-bottom: 40px;
  width: 100px;
}

.legend-key {
  display: inline-block;
  border-radius: 20%;
  width: 10px;
  height: 10px;
  margin-right: 5px;
}
</style>
</head>
<body>
  <div id="map"></div>
  <div class='map-overlay' id='legend'>
    <div class='group0' id='group0'></div>
    <div class='group1' id='group1'></div>
<div class='group2' id='group2'></div>
<div class='group3' id='group3'></div>
  </div>
<script>
  var popup;
  
mapboxgl.accessToken = 'pk.eyJ1Ijoib2J1Y2hlbCIsImEiOiJmOWQ2MzQxNmE0M2Y3YmVjNzA2NmM2MGQzYTIwYmQ3OCJ9.psxJSN8q9n2-HfFGoIUNJA';
var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/light-v10',
center: [-96, 37.8],
zoom: 3
});
map.addControl(new mapboxgl.NavigationControl(), 'top-left');      
map.addControl(new mapboxgl.FullscreenControl(), 'bottom-left');
// disable map rotation using right click + drag
map.dragRotate.disable();

// disable map rotation using touch rotation gesture
map.touchZoomRotate.disableRotation();  
map.on('load', function () {
map.getCanvas().style.cursor = 'default';
    // Add an image to use as a custom marker
var layers = ['0-10', '10-20', '20-50', '50-100', '100-200', '200-500', '500-1000', '1000+'];
var colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];

for (i = 0; i < layers.length; i++) {
  var layer = layers[i];
  var color = colors[i];
  var item = document.createElement('div');
  var key = document.createElement('span');
  key.className = 'legend-key';
  key.style.backgroundColor = color;

  var value = document.createElement('span');
  value.innerHTML = layer;
  item.appendChild(key);
  item.appendChild(value);
  legend.appendChild(item);
}

var dd=map.addSource('points1', {
'type': 'geojson',
'data': 'supercommunities_twitter_improved_all2_short_last2_7_1_updated2_filtered_5.json'
});
// Add a symbol layer                                                                                                                                                                
map.addLayer({
'id': 'points1',
'type': 'circle',
'source': 'points1',
    'paint':{
// make circles larger as the user zooms from z12 to z22                                                                                                                            
 //   'circle-radius': 3,                                                                                                                                                           
    'circle-radius': ['get', 's'],
// color circles by ethnicity, using a match expression                                                                                                                             
// https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match                                                                                                               
    'circle-color': ['get', 'color'],
    'circle-stroke-color':'#000000',
    'circle-stroke-width':0.2

}
});    
map.once('idle', function(e) {    
const features = map.querySourceFeatures('points1');                                                                                                                         
    console.log(features);
});
    map.on('click', 'points1', function(e) {

//var features = map.querySourceFeatures('points1');
//console.log(features);
	if (typeof popup=="object") popup.remove();
	//var features = map.querySourceFeatures('points1');
     //console.log(features);

    var lats=e.lngLat;
    var htm=e.features[0]["properties"]["title"]+" "+e.features[0]["properties"]["color"];
popup=new mapboxgl.Popup()
.setLngLat(lats)
.setHTML(htm)
	    .addTo(map);
	var l=e.features[0]['properties']['title'].split(' ')[2];
	//console.log(l);

	fetch(l.substr(0,2)+'.json')
  .then(response => response.json())
	    .then(data => {
		var dd=data[l];
		var kkeys=d3.keys(dd);
		kkeys.push(l);
		//console.log(d3.values(dd));
		//console.log(dd);

		var kks=[];
		var vals=[];
		var kks0=[];
                var vals0=[];
for (var i=0; i<kkeys.length; i++) {
    kks.push(kkeys[i]);
     kks0.push(2);
    vals.push(2+d3.values(dd)[i]/d3.sum(d3.values(dd))*10);
    vals0.push(0.5);
}		    
		map.setPaintProperty("points1", 'circle-opacity', ['match', ['get', 'id'], kkeys, 1.0,0.1]);
		map.setPaintProperty("points1", 'circle-stroke-opacity', ['match', ['get', 'id'], kkeys, 1.0,0.1]);
	    });
    });
});
</script>
 
</body>
</html>
